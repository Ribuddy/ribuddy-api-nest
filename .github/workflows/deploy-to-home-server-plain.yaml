name: Deploy to Home Server (Plain)

on:
  # push:
  #   branches:
  #     - develop
  workflow_dispatch:

jobs:
  deploy-to-home-server:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # - name: pnpm ÏÑ§Ïπò
      #   uses: pnpm/action-setup@v4
      #   with:
      #     version: 10
      #     run_install: true

      # - name: Install Node.js # pnpm ÏÑ§ÏπòÎ•º ÌïòÎçîÎùºÎèÑ nodeÎäî Ï∂îÍ∞ÄÎ°ú ÏÑ§Ïπò ÌïÑÏöî
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: 22
      #     cache: 'pnpm'

      # - name: Build the project
      #   run: |
      #     echo "üèóÔ∏è  Nest ProjectÎ•º Build Ìï©ÎãàÎã§."
      #     pnpm run build

      - name: Ìôà ÏÑúÎ≤ÑÏóê checkout Îêú ÏΩîÎìú Î≥µÏÇ¨
        uses: appleboy/scp-action@v0.1.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: '.'
          target: '${{ secrets.APP_DIRECTORY }}'
          rm: true

      - name: SSH Ï†ëÏÜç Î∞è Ïä§ÌÅ¨Î¶ΩÌä∏ Ïã§Ìñâ
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            #!/bin/bash
            bash -c '
            echo "‚úÖ SSH Connected ..."
            echo "üë§ Current User: $(whoami)"
            echo "üñ•Ô∏è Host Name: $(hostname)"
            echo "‚è∞ Current Time: $(date)"
            echo "üìÅ Current Directory: $(pwd)"

            if [ -d "${{ secrets.APP_DIRECTORY }}" ]; then
              echo "üìÇ ${{ secrets.APP_DIRECTORY }} Directory exists, proceeding with deployment..."
            else
              echo "‚ùå ${{ secrets.APP_DIRECTORY }} Directory does not exist. Exiting deployment."
              exit 1
            fi

            cd ${{ secrets.APP_DIRECTORY }}

            echo "üìÇ Changed to application directory: $(pwd)"

            echo "Creating .env files"
            echo "${{ secrets.DOTENV_DEFAULT }}" | awk 'NF' > .env
            echo "${{ secrets.DOTENV_DEVELOPMENT }}" | awk 'NF' > .env.development

            echo "üìÇ Listing files in the application directory:"
            ls -la

            echo "üîß Running the shell script ... ${{ secrets.SHELL_SCRIPT_PATH }}"
            chmod +x ${{ secrets.SHELL_SCRIPT_PATH }}
            bash ${{ secrets.SHELL_SCRIPT_PATH }}

            if [ $? -eq 0 ]; then
              echo "‚úÖ Script executed successfully!"
            else
              echo "‚ùå Script execution failed. Please check the logs."
              exit 1
            fi
            '
